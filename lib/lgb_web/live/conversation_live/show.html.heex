<.page_align no_padding={true}>
  <.card class="flex sm:h-[calc(100vh-126px)] md:h-[calc(100vh-64px)] h-[calc(100vh-106px)] flex-col">
    <!-- Chat Header -->
    <.card class="flex items-center justify-between">
      <div class="flex items-center gap-2 align-middle">
        <img
          src={Lgb.Profiles.ProfilePicture.get_picture_url(@other_profile.first_picture)}
          alt="Avatar"
          class="h-12 w-12 rounded-full object-cover"
        />
        <span class="text-lg font-semibold">
          <.link navigate={~p"/profiles/#{@other_profile.id}"}>
            <.name_with_online_activity profile={@other_profile} primary={false} />
          </.link>
        </span>
      </div>
      <span class="text-xs font-light text-gray-400">
        <%= cond do %>
          <% LgbWeb.UserPresence.within_minutes?(@other_profile.user.last_login_at, 60) -> %>
            {LgbWeb.UserPresence.format_hours_ago(@other_profile.user.last_login_at)}
          <% LgbWeb.UserPresence.within_hours?(@other_profile.user.last_login_at, 24) -> %>
            Last active yesterday
          <% true -> %>
            Last active {Calendar.strftime(
              @other_profile.user.last_login_at || DateTime.utc_now(),
              "%b %d"
            )}
        <% end %>
      </span>
    </.card>
    <div
      id="conversation-messages"
      phx-update="stream"
      phx-viewport-top="load_more"
      class="h-full flex-1 overflow-y-auto"
      phx-hook="ScrollBottom"
    >
      <div :for={{dom_id, message} <- @streams.all_messages} id={dom_id}>
        <div class={"flex " <> if message.profile.id == @current_profile.id, do: "justify-end", else: "justify-start"}>
          <div class={"max-w-[70%] mx-1 my-1 rounded-3xl p-3 text-sm " <> if message.profile.id == @current_profile.id, do: "bg-green-100", else: "bg-purple-100"}>
            <div class="flex items-end gap-1">
              <div class={"flex flex-col " <> if message.profile.id == @current_profile.id, do: "items-end", else: "items-start"}>
                <span>{message.content}</span>
                <span class="text-xs font-bold text-gray-500">
                  {Calendar.strftime(message.inserted_at, "%b %d - %I:%M %p")}
                  <span :if={message.profile.id == @current_profile.id} class="ml-1">
                    <span :if={message.read} class="text-blue-800">✓✓</span>
                    <span :if={!message.read} class="text-gray-400">✓✓</span>
                  </span>
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <.chat_simple_form for={@form} phx-change="validate" phx-submit="send">
      <div class="flex w-full space-x-2 rounded-b-lg bg-white p-4 shadow-sm">
        <.input
          id="one-one-message"
          class="rounded-lg p-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
          field={@form[:content]}
          name="content"
          placeholder="Type a message..."
        />
        <.button class="bg-colorPrimary rounded-lg px-4 py-2 text-white hover:bg-colorPrimary focus:outline-none focus:ring-2 focus:ring-blue-500">
          Send
        </.button>
      </div>
    </.chat_simple_form>
  </.card>
</.page_align>
